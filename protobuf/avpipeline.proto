syntax = "proto3";
package avpipeline;
option go_package = "github.com/xaionaro-go/avpipeline/protobuf/avpipeline;avpipeline";
import "libav.proto";

message Node {
    uint64 id = 1;
    string type = 2;
    string description = 3;
    bool isServing = 4;
    NodeCounters counters = 5;
    repeated Node TODO_publishingNodes = 6; // is not currently reported
    repeated Node consumingNodes = 7;
}

message NodeCounters {
    NodeCountersSection received = 1;
    NodeCountersSection processed = 2;
    NodeCountersSection missed = 3;
    NodeCountersSection generated = 4;
    NodeCountersSection omitted = 5;
    NodeCountersSection sent = 6;
}

message NodeCountersSection {
    NodeCountersSubSection packets = 1;
    NodeCountersSubSection frames = 2;
}

message NodeCountersSubSection {
    NodeCountersItem unknown = 1;
    NodeCountersItem other = 2;
    NodeCountersItem video = 3;
    NodeCountersItem audio = 4;
}

message NodeCountersItem {
    uint64 count = 1;
    uint64 bytes = 2;
}

message Object {
  uint32 type = 1;
  bytes data = 2;
}

/*
type Commons struct {
	*astiav.Frame
	*astiav.CodecContext
	StreamIndex    int
	StreamsCount   int
	StreamDuration int64
	TimeBase       astiav.Rational
	Pos            int64
	Duration       int64
}
*/

message Frame {
  libav.Frame frame = 1;
  libav.CodecContext codecContext = 2;
  int32 streamIndex = 3;
  int32 streamsCount = 4;
  int64 streamDuration = 5;
  libav.Rational timeBase = 6;
  int64 pos = 7;
  int64 duration = 8;
}

message AutoBitrateCalculator {
  oneof AutoBitrateCalculator {
    AutoBitRateCalculatorThresholds thresholds = 1;
    AutoBitrateCalculatorLogK logK = 2;
    uint64 static = 3;
    AutoBitrateCalculatorQueueSizeGapDecay queueSizeGapDecay = 4;
  }
}

message AutoBitRateCalculatorThresholds {
  uint64 outputExtremelyHighQueueSizeDurationMS = 1;
  uint64 outputVeryHighQueueSizeDurationMS = 2;
  uint64 outputHighQueueSizeDurationMS = 3;
  uint64 outputLowQueueSizeDurationMS = 4;
  uint64 outputVeryLowQueueSizeDurationMS = 5;
  double increaseK = 6;
  double decreaseK = 7;
  double quickIncreaseK = 8;
  double quickDecreaseK = 9;
  double extremeDecreaseK = 10;
}
message MovingAverageConfigMAMA {
  double fastLimit = 1;
  double slowLimit = 2;
}

message MovingAverageConfigOther {
  string jsonConfig = 1;
}

message MovingAverageConfig {
  oneof MovingAverageConfig {
    MovingAverageConfigMAMA mama = 1;
    MovingAverageConfigOther other = 65535;
  }
}

message AutoBitrateCalculatorLogK {
  uint64 queueOptimalMS = 1;
  double inertia = 2; // [0.0..1.0]
  MovingAverageConfig movingAverage = 3;
}

message AutoBitrateCalculatorQueueSizeGapDecay {
  uint64 queueOptimalMS = 1;
  uint64 queueSizeMin = 2; // in bits
  uint64 gapDecayMS = 3;
  uint64 increaseInertiaMS = 4;
  MovingAverageConfig derivativeSmoothed = 5;
}

enum MonitorEventType {
  UNDEFINED_EVENT_TYPE = 0;
  EVENT_TYPE_RECEIVE = 1;
  EVENT_TYPE_SEND = 2;
  EVENT_TYPE_KERNEL_OUTPUT_SEND = 128;
}

message MonitorRequest {
  uint64 node_id = 1;
  MonitorEventType event_type = 2;
  bool include_packet_payload = 3;
  bool include_frame_payload = 4;
  bool do_decode = 5;
}

message MonitorEvent {
  uint64 source_kernel_id = 1;
  libav.Stream stream = 2;
  optional libav.Packet packet = 3;
  repeated libav.Frame frames = 4;
  bytes pipeline_side_data = 5;
}
